import { voidMap } from '../parser/tokenizer-event-handlers';
import { isLiteral } from '../utils';
import { escapeText, escapeAttrValue } from './util';
function unreachable() {
    throw new Error('unreachable');
}
export default function build(ast) {
    if (!ast) {
        return '';
    }
    const output = [];
    switch (ast.type) {
        case 'Program':
            {
                const chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                const body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (ast.blockParams.length) {
                output.push(' ', 'as', ' ', `|${ast.blockParams.join(' ')}|`);
            }
            if (voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            if (ast.value.type === 'TextNode') {
                if (ast.value.chars !== '') {
                    output.push(ast.name, '=');
                    output.push('"', escapeAttrValue(ast.value.chars), '"');
                } else {
                    output.push(ast.name);
                }
            } else {
                output.push(ast.name, '=');
                // ast.value is mustache or concat
                output.push(build(ast.value));
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(node => {
                if (node.type === 'TextNode') {
                    output.push(escapeAttrValue(node.chars));
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(escapeText(ast.chars));
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                const lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push(`"${ast.value}"`);
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(pair => {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(`${ast.key}=${build(ast.value)}`);
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    const newArray = [];
    array.forEach(a => {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    let path;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if (isLiteral(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    const params = block.program.blockParams;
    if (params.length) {
        return ` as |${params.join(' ')}|`;
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsQUFBTyxTQUFFLEFBQU8sQUFBRSxlQUFNLEFBQW9DLEFBQUM7QUFDN0QsQUFBTyxTQUFFLEFBQVMsQUFBRSxpQkFBTSxBQUFVLEFBQUM7QUFDckMsQUFBTyxTQUFFLEFBQVUsWUFBRSxBQUFlLEFBQUUsdUJBQU0sQUFBUSxBQUFDO0FBRXJELFNBQVMsQUFBVztBQUNsQixVQUFNLElBQUksQUFBSyxNQUFDLEFBQWEsQUFBQyxBQUFDLEFBQ2pDO0FBQUM7QUFFRCxBQUFNLEFBQUMsQUFBTyx3QkFBVSxBQUFLLE1BQUMsQUFBYTtBQUN6QyxRQUFJLENBQUMsQUFBRyxLQUFFO0FBQ1IsZUFBTyxBQUFFLEFBQUM7QUFDWDtBQUNELFVBQU0sQUFBTSxTQUFhLEFBQUUsQUFBQztBQUU1QixZQUFRLEFBQUcsSUFBQyxBQUFJLEFBQUU7QUFDaEIsYUFBSyxBQUFTO0FBQ1o7QUFDRSxzQkFBTSxBQUFVLGFBQUcsQUFBRyxJQUFDLEFBQVMsQUFBQyxjQUFJLEFBQUcsSUFBQyxBQUFJLEtBQUMsQUFBQyxBQUFDLEFBQUM7QUFDakQsb0JBQUksQUFBVSxZQUFFO0FBQ2QsQUFBVSwrQkFBQyxBQUFTLEFBQUMsYUFBRyxBQUFJLEFBQUM7QUFDOUI7QUFDRCxzQkFBTSxBQUFJLE9BQUcsQUFBUyxVQUFDLEFBQUcsSUFBQyxBQUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUM7QUFDMUMsQUFBTSx1QkFBQyxBQUFJLEtBQUMsQUFBSSxBQUFDLEFBQUM7QUFDbkI7QUFDRCxBQUFNO0FBQ1IsYUFBSyxBQUFhO0FBQ2hCLEFBQU0sbUJBQUMsQUFBSSxLQUFDLEFBQUcsS0FBRSxBQUFHLElBQUMsQUFBRyxBQUFDLEFBQUM7QUFDMUIsZ0JB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QUFDLEFBQ3BGO0FBQUM7QUFFRCxTQUFTLEFBQVcsWUFBQyxBQUF1QixPQUFFLEFBQWtCO0FBQzlELFdBQU8sQUFBTyxRQUFDLEFBQUssQUFBQyxPQUFDLEFBQUksS0FBQyxBQUFTLGFBQUksQUFBRSxBQUFDLEFBQUMsQUFDOUM7QUFBQztBQUVELFNBQVMsQUFBVyxZQUFDLEFBQXlCO0FBQzVDLFVBQU0sQUFBTSxTQUFHLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBVyxBQUFDO0FBQ3pDLFFBQUksQUFBTSxPQUFDLEFBQU0sUUFBRTtBQUNqQixBQUFPLHVCQUFRLEFBQU0sT0FBQyxBQUFJLEtBQUMsQUFBRyxBQUFDLElBQUcsQUFBQztBQUNwQztBQUVELFdBQU8sQUFBSSxBQUFDLEFBQ2Q7QUFBQztBQUVELFNBQVMsQUFBUyxVQUFDLEFBQXlCO0FBQzFDLFdBQU8sQ0FBQyxBQUFLLE9BQUUsQUFBVSxXQUFDLEFBQUssQUFBQyxRQUFFLEFBQVcsWUFBQyxBQUFLLEFBQUMsUUFBRSxBQUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDdkU7QUFBQztBQUVELFNBQVMsQUFBVSxXQUFDLEFBQVU7QUFDNUIsV0FBTyxDQUFDLEFBQUssT0FBRSxBQUFLLE1BQUMsQUFBSyxNQUFDLEFBQUksQUFBQyxPQUFFLEFBQUksQUFBQyxNQUFDLEFBQUksS0FBQyxBQUFFLEFBQUMsQUFBQyxBQUNuRDtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgKiBhcyBIQlMgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IHsgdm9pZE1hcCB9IGZyb20gJy4uL3BhcnNlci90b2tlbml6ZXItZXZlbnQtaGFuZGxlcnMnO1xuaW1wb3J0IHsgaXNMaXRlcmFsIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgZXNjYXBlVGV4dCwgZXNjYXBlQXR0clZhbHVlIH0gZnJvbSAnLi91dGlsJztcblxuZnVuY3Rpb24gdW5yZWFjaGFibGUoKTogbmV2ZXIge1xuICB0aHJvdyBuZXcgRXJyb3IoJ3VucmVhY2hhYmxlJyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGJ1aWxkKGFzdDogSEJTLk5vZGUpOiBzdHJpbmcge1xuICBpZiAoIWFzdCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICBjb25zdCBvdXRwdXQ6IHN0cmluZ1tdID0gW107XG5cbiAgc3dpdGNoIChhc3QudHlwZSkge1xuICAgIGNhc2UgJ1Byb2dyYW0nOlxuICAgICAge1xuICAgICAgICBjb25zdCBjaGFpbkJsb2NrID0gYXN0WydjaGFpbmVkJ10gJiYgYXN0LmJvZHlbMF07XG4gICAgICAgIGlmIChjaGFpbkJsb2NrKSB7XG4gICAgICAgICAgY2hhaW5CbG9ja1snY2hhaW5lZCddID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBib2R5ID0gYnVpbGRFYWNoKGFzdC5ib2R5KS5qb2luKCcnKTtcbiAgICAgICAgb3V0cHV0LnB1c2goYm9keSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaCgnPCcsIGFzdC50YWcpO1xuICAgICAgaWYgKGFzdC5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuYXR0cmlidXRlcykuam9pbignICcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChhc3QubW9kaWZpZXJzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QubW9kaWZpZXJzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYgKGFzdC5jb21tZW50cy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmNvbW1lbnRzKS5qb2luKCcgJykpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYXN0LmJsb2NrUGFyYW1zLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsICdhcycsICcgJywgYHwke2FzdC5ibG9ja1BhcmFtcy5qb2luKCcgJyl9fGApO1xuICAgICAgfVxuXG4gICAgICBpZiAodm9pZE1hcFthc3QudGFnXSkge1xuICAgICAgICBpZiAoYXN0LnNlbGZDbG9zaW5nKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goJyAvJyk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJz4nKTtcbiAgICAgICAgb3V0cHV0LnB1c2guYXBwbHkob3V0cHV0LCBidWlsZEVhY2goYXN0LmNoaWxkcmVuKSk7XG4gICAgICAgIG91dHB1dC5wdXNoKCc8LycsIGFzdC50YWcsICc+Jyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdBdHRyTm9kZSc6XG4gICAgICBpZiAoYXN0LnZhbHVlLnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgICAgaWYgKGFzdC52YWx1ZS5jaGFycyAhPT0gJycpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSwgJz0nKTtcbiAgICAgICAgICBvdXRwdXQucHVzaCgnXCInLCBlc2NhcGVBdHRyVmFsdWUoYXN0LnZhbHVlLmNoYXJzKSwgJ1wiJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goYXN0Lm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXQucHVzaChhc3QubmFtZSwgJz0nKTtcbiAgICAgICAgLy8gYXN0LnZhbHVlIGlzIG11c3RhY2hlIG9yIGNvbmNhdFxuICAgICAgICBvdXRwdXQucHVzaChidWlsZChhc3QudmFsdWUpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbmNhdFN0YXRlbWVudCc6XG4gICAgICBvdXRwdXQucHVzaCgnXCInKTtcbiAgICAgIGFzdC5wYXJ0cy5mb3JFYWNoKChub2RlOiBIQlMuVGV4dE5vZGUgfCBIQlMuTXVzdGFjaGVTdGF0ZW1lbnQpID0+IHtcbiAgICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGVzY2FwZUF0dHJWYWx1ZShub2RlLmNoYXJzKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goYnVpbGQobm9kZSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIG91dHB1dC5wdXNoKCdcIicpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnVGV4dE5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2goZXNjYXBlVGV4dChhc3QuY2hhcnMpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ011c3RhY2hlU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eycsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ011c3RhY2hlQ29tbWVudFN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3shLS0nLCBhc3QudmFsdWUsICctLX19J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0VsZW1lbnRNb2RpZmllclN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3snLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXRoRXhwcmVzc2lvbic6XG4gICAgICBvdXRwdXQucHVzaChhc3Qub3JpZ2luYWwpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnU3ViRXhwcmVzc2lvbic6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcoJywgcGF0aFBhcmFtcyhhc3QpLCAnKScpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQm9vbGVhbkxpdGVyYWwnOlxuICAgICAgb3V0cHV0LnB1c2goYXN0LnZhbHVlID8gJ3RydWUnIDogJ2ZhbHNlJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdCbG9ja1N0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgIGlmIChhc3RbJ2NoYWluZWQnXSkge1xuICAgICAgICAgIGxpbmVzLnB1c2goWyd7e2Vsc2UgJywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXS5qb2luKCcnKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGluZXMucHVzaChvcGVuQmxvY2soYXN0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBsaW5lcy5wdXNoKGJ1aWxkKGFzdC5wcm9ncmFtKSk7XG5cbiAgICAgICAgaWYgKGFzdC5pbnZlcnNlKSB7XG4gICAgICAgICAgaWYgKCFhc3QuaW52ZXJzZVsnY2hhaW5lZCddKSB7XG4gICAgICAgICAgICBsaW5lcy5wdXNoKCd7e2Vsc2V9fScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsaW5lcy5wdXNoKGJ1aWxkKGFzdC5pbnZlcnNlKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWFzdFsnY2hhaW5lZCddKSB7XG4gICAgICAgICAgbGluZXMucHVzaChjbG9zZUJsb2NrKGFzdCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgb3V0cHV0LnB1c2gobGluZXMuam9pbignJykpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGFydGlhbFN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3s+JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQ29tbWVudFN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsnPCEtLScsIGFzdC52YWx1ZSwgJy0tPiddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdTdHJpbmdMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goYFwiJHthc3QudmFsdWV9XCJgKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ051bWJlckxpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChTdHJpbmcoYXN0LnZhbHVlKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdVbmRlZmluZWRMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ3VuZGVmaW5lZCcpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTnVsbExpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgnbnVsbCcpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnSGFzaCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKFxuICAgICAgICAgIGFzdC5wYWlyc1xuICAgICAgICAgICAgLm1hcChwYWlyID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIGJ1aWxkKHBhaXIpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5qb2luKCcgJylcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0hhc2hQYWlyJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goYCR7YXN0LmtleX09JHtidWlsZChhc3QudmFsdWUpfWApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gIH1cbiAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gY29tcGFjdChhcnJheTogT3B0aW9uPHN0cmluZz5bXSk6IHN0cmluZ1tdIHtcbiAgY29uc3QgbmV3QXJyYXk6IGFueVtdID0gW107XG4gIGFycmF5LmZvckVhY2goYSA9PiB7XG4gICAgaWYgKHR5cGVvZiBhICE9PSAndW5kZWZpbmVkJyAmJiBhICE9PSBudWxsICYmIGEgIT09ICcnKSB7XG4gICAgICBuZXdBcnJheS5wdXNoKGEpO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBuZXdBcnJheTtcbn1cblxuZnVuY3Rpb24gYnVpbGRFYWNoKGFzdHM6IEhCUy5Ob2RlW10pOiBzdHJpbmdbXSB7XG4gIHJldHVybiBhc3RzLm1hcChidWlsZCk7XG59XG5cbmZ1bmN0aW9uIHBhdGhQYXJhbXMoYXN0OiBIQlMuTm9kZSk6IHN0cmluZyB7XG4gIGxldCBwYXRoOiBzdHJpbmc7XG5cbiAgc3dpdGNoIChhc3QudHlwZSkge1xuICAgIGNhc2UgJ011c3RhY2hlU3RhdGVtZW50JzpcbiAgICBjYXNlICdTdWJFeHByZXNzaW9uJzpcbiAgICBjYXNlICdFbGVtZW50TW9kaWZpZXJTdGF0ZW1lbnQnOlxuICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50JzpcbiAgICAgIGlmIChpc0xpdGVyYWwoYXN0LnBhdGgpKSB7XG4gICAgICAgIHJldHVybiBTdHJpbmcoYXN0LnBhdGgudmFsdWUpO1xuICAgICAgfVxuXG4gICAgICBwYXRoID0gYnVpbGQoYXN0LnBhdGgpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGFydGlhbFN0YXRlbWVudCc6XG4gICAgICBwYXRoID0gYnVpbGQoYXN0Lm5hbWUpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiB1bnJlYWNoYWJsZSgpO1xuICB9XG5cbiAgcmV0dXJuIGNvbXBhY3RKb2luKFtwYXRoLCBidWlsZEVhY2goYXN0LnBhcmFtcykuam9pbignICcpLCBidWlsZChhc3QuaGFzaCldLCAnICcpO1xufVxuXG5mdW5jdGlvbiBjb21wYWN0Sm9pbihhcnJheTogT3B0aW9uPHN0cmluZz5bXSwgZGVsaW1pdGVyPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGNvbXBhY3QoYXJyYXkpLmpvaW4oZGVsaW1pdGVyIHx8ICcnKTtcbn1cblxuZnVuY3Rpb24gYmxvY2tQYXJhbXMoYmxvY2s6IEhCUy5CbG9ja1N0YXRlbWVudCk6IE9wdGlvbjxzdHJpbmc+IHtcbiAgY29uc3QgcGFyYW1zID0gYmxvY2sucHJvZ3JhbS5ibG9ja1BhcmFtcztcbiAgaWYgKHBhcmFtcy5sZW5ndGgpIHtcbiAgICByZXR1cm4gYCBhcyB8JHtwYXJhbXMuam9pbignICcpfXxgO1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIG9wZW5CbG9jayhibG9jazogSEJTLkJsb2NrU3RhdGVtZW50KTogc3RyaW5nIHtcbiAgcmV0dXJuIFsne3sjJywgcGF0aFBhcmFtcyhibG9jayksIGJsb2NrUGFyYW1zKGJsb2NrKSwgJ319J10uam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNsb3NlQmxvY2soYmxvY2s6IGFueSk6IHN0cmluZyB7XG4gIHJldHVybiBbJ3t7LycsIGJ1aWxkKGJsb2NrLnBhdGgpLCAnfX0nXS5qb2luKCcnKTtcbn1cbiJdfQ==