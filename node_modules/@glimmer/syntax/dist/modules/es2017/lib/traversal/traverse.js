import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function getEnterFunction(handler) {
    return typeof handler === 'function' ? handler : handler.enter;
}
function getExitFunction(handler) {
    return typeof handler !== 'function' ? handler.exit : undefined;
}
function getKeyHandler(handler, key) {
    let keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    let keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        // widen specific key to all keys
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    let handler = visitor[nodeType];
    if (handler !== undefined) {
        // widen specific Node to all nodes
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, node) {
    let handler = getNodeHandler(visitor, node.type);
    let enter;
    let exit;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    let result;
    if (enter !== undefined) {
        result = enter(node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            visitArray(visitor, result);
            return result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        let keys = visitorKeys[node.type];
        for (let i = 0; i < keys.length; i++) {
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, node, keys[i]);
        }
        if (exit !== undefined) {
            result = exit(node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    let value = node[key];
    if (!value) {
        return;
    }
    let keyEnter;
    let keyExit;
    if (handler !== undefined) {
        let keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        let result = visitNode(visitor, value);
        if (result !== undefined) {
            assignKey(node, key, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (let i = 0; i < array.length; i++) {
        let result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice(index, 1, ...result);
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(visitor, node);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUFNbEIsU0FBUyxBQUFnQixpQkFDdkIsQUFBaUM7QUFFakMsV0FBTyxPQUFPLEFBQU8sWUFBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sQUFBQyxBQUFDLFVBQUMsQUFBTyxRQUFDLEFBQUssQUFBQyxBQUNqRTtBQUFDO0FBSUQsU0FBUyxBQUFlLGdCQUN0QixBQUFpQztBQUVqQyxXQUFPLE9BQU8sQUFBTyxZQUFLLEFBQVUsQUFBQyxBQUFDLGFBQUMsQUFBTyxRQUFDLEFBQUksQUFBQyxBQUFDLE9BQUMsQUFBUyxBQUFDLEFBQ2xFO0FBQUM7QUFFRCxTQUFTLEFBQWEsY0FBQyxBQUFvQixTQUFFLEFBQWE7QUFDeEQsUUFBSSxBQUFVLGFBQUcsT0FBTyxBQUFPLFlBQUssQUFBVSxBQUFDLEFBQUMsYUFBQyxBQUFPLFFBQUMsQUFBSSxBQUFDLEFBQUMsT0FBQyxBQUFTLEFBQUM7QUFDMUUsUUFBSSxBQUFVLGVBQUssQUFBUyxXQUFFLEFBQU87QUFDckMsUUFBSSxBQUFVLGFBQUcsQUFBVSxXQUFDLEFBQUcsQUFBQyxBQUFDO0FBQ2pDLFFBQUksQUFBVSxlQUFLLEFBQVMsV0FBRTtBQUM1QixBQUFpQztBQUNqQyxlQUFPLEFBQXdCLEFBQUM7QUFDakM7QUFDRCxXQUFPLEFBQVUsV0FBQyxBQUFHLEFBQUMsQUFDeEI7QUFBQztBQUVELFNBQVMsQUFBYyxlQUFDLEFBQW9CLFNBQUUsQUFBa0I7QUFDOUQsUUFBSSxBQUFPLFVBQUcsQUFBTyxRQUFD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ZW50IjpbImltcG9ydCB2aXNpdG9yS2V5cyBmcm9tICcuLi90eXBlcy92aXNpdG9yLWtleXMnO1xuaW1wb3J0IHtcbiAgY2Fubm90UmVtb3ZlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldCxcbn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgTm9kZSwgTm9kZVR5cGUsIFBhcmVudE5vZGUsIENoaWxkS2V5IH0gZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0IHsgTm9kZVZpc2l0b3IsIE5vZGVGdW5jdGlvbiwgTm9kZUhhbmRsZXIsIEtleUZ1bmN0aW9uLCBLZXlIYW5kbGVyIH0gZnJvbSAnLi4vdHlwZXMvdmlzaXRvcic7XG5cbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcjogS2V5SGFuZGxlcik6IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbihoYW5kbGVyOiBOb2RlSGFuZGxlcik6IE5vZGVGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb24oXG4gIGhhbmRsZXI6IE5vZGVIYW5kbGVyIHwgS2V5SGFuZGxlclxuKTogTm9kZUZ1bmN0aW9uIHwgS2V5RnVuY3Rpb24gfCB1bmRlZmluZWQge1xuICByZXR1cm4gdHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicgPyBoYW5kbGVyIDogaGFuZGxlci5lbnRlcjtcbn1cblxuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uKGhhbmRsZXI6IEtleUhhbmRsZXIpOiBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbihoYW5kbGVyOiBOb2RlSGFuZGxlcik6IE5vZGVGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbihcbiAgaGFuZGxlcjogTm9kZUhhbmRsZXIgfCBLZXlIYW5kbGVyXG4pOiBOb2RlRnVuY3Rpb24gfCBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZCB7XG4gIHJldHVybiB0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJyA/IGhhbmRsZXIuZXhpdCA6IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gZ2V0S2V5SGFuZGxlcihoYW5kbGVyOiBOb2RlSGFuZGxlciwga2V5OiBDaGlsZEtleSk6IEtleUhhbmRsZXIgfCB1bmRlZmluZWQge1xuICBsZXQga2V5VmlzaXRvciA9IHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nID8gaGFuZGxlci5rZXlzIDogdW5kZWZpbmVkO1xuICBpZiAoa2V5VmlzaXRvciA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG4gIGxldCBrZXlIYW5kbGVyID0ga2V5VmlzaXRvcltrZXldO1xuICBpZiAoa2V5SGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgLy8gd2lkZW4gc3BlY2lmaWMga2V5IHRvIGFsbCBrZXlzXG4gICAgcmV0dXJuIGtleUhhbmRsZXIgYXMgS2V5SGFuZGxlcjtcbiAgfVxuICByZXR1cm4ga2V5VmlzaXRvci5BbGw7XG59XG5cbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlVHlwZTogTm9kZVR5cGUpOiBOb2RlSGFuZGxlciB8IHVuZGVmaW5lZCB7XG4gIGxldCBoYW5kbGVyID0gdmlzaXRvcltub2RlVHlwZV07XG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyB3aWRlbiBzcGVjaWZpYyBOb2RlIHRvIGFsbCBub2Rlc1xuICAgIHJldHVybiBoYW5kbGVyIGFzIE5vZGVIYW5kbGVyO1xuICB9XG4gIHJldHVybiB2aXNpdG9yLkFsbDtcbn1cblxuZnVuY3Rpb24gdmlzaXROb2RlKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlOiBOb2RlKTogTm9kZSB8IE5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkIHtcbiAgbGV0IGhhbmRsZXIgPSBnZXROb2RlSGFuZGxlcih2aXNpdG9yLCBub2RlLnR5cGUpO1xuICBsZXQgZW50ZXI6IE5vZGVGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbiAgbGV0IGV4aXQ6IE5vZGVGdW5jdGlvbiB8IHVuZGVmaW5lZDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgZW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGhhbmRsZXIpO1xuICAgIGV4aXQgPSBnZXRFeGl0RnVuY3Rpb24oaGFuZGxlcik7XG4gIH1cblxuICBsZXQgcmVzdWx0OiBOb2RlIHwgTm9kZVtdIHwgdW5kZWZpbmVkIHwgbnVsbCB8IHZvaWQ7XG4gIGlmIChlbnRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmVzdWx0ID0gZW50ZXIobm9kZSk7XG4gIH1cblxuICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgcmVzdWx0ICE9PSBudWxsKSB7XG4gICAgaWYgKEpTT04uc3RyaW5naWZ5KG5vZGUpID09PSBKU09OLnN0cmluZ2lmeShyZXN1bHQpKSB7XG4gICAgICByZXN1bHQgPSB1bmRlZmluZWQ7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICAgIHZpc2l0QXJyYXkodmlzaXRvciwgcmVzdWx0KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcmVzdWx0KSB8fCByZXN1bHQ7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleXMgPSB2aXNpdG9yS2V5c1tub2RlLnR5cGVdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIG5vZGUgYXMgUGFyZW50Tm9kZSwga2V5c1tpXSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzdWx0ID0gZXhpdChub2RlKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB2aXNpdEtleShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGhhbmRsZXI6IE5vZGVIYW5kbGVyIHwgdW5kZWZpbmVkLFxuICBub2RlOiBQYXJlbnROb2RlLFxuICBrZXk6IENoaWxkS2V5XG4pIHtcbiAgbGV0IHZhbHVlID0gbm9kZVtrZXldIGFzIE5vZGUgfCBOb2RlW10gfCBudWxsIHwgdW5kZWZpbmVkO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGtleUVudGVyOiBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbiAgbGV0IGtleUV4aXQ6IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkO1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5SGFuZGxlciA9IGdldEtleUhhbmRsZXIoaGFuZGxlciwga2V5KTtcbiAgICBpZiAoa2V5SGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBrZXlFbnRlciA9IGdldEVudGVyRnVuY3Rpb24oa2V5SGFuZGxlcik7XG4gICAgICBrZXlFeGl0ID0gZ2V0RXhpdEZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlFbnRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUVudGVyKG5vZGUsIGtleSkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgdmlzaXRBcnJheSh2aXNpdG9yLCB2YWx1ZSk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCB2YWx1ZSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBhc3NpZ25LZXkobm9kZSwga2V5LCByZXN1bHQpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlFeGl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoa2V5RXhpdChub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB2aXNpdEFycmF5KHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBhcnJheTogTm9kZVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGFycmF5W2ldKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXkobm9kZTogTm9kZSwga2V5OiBDaGlsZEtleSwgcmVzdWx0OiBOb2RlIHwgTm9kZVtdIHwgbnVsbCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5vZGVba2V5XSA9IHJlc3VsdFswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG5vZGVba2V5XSA9IHJlc3VsdDtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheShhcnJheTogTm9kZVtdLCBpbmRleDogbnVtYmVyLCByZXN1bHQ6IE5vZGUgfCBOb2RlW10gfCBudWxsKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHJldHVybiAwO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgLi4ucmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIHJlc3VsdCk7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdHJhdmVyc2Uobm9kZTogTm9kZSwgdmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgdmlzaXROb2RlKHZpc2l0b3IsIG5vZGUpO1xufVxuIl19