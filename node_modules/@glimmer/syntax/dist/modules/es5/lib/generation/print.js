import { voidMap } from '../parser/tokenizer-event-handlers';
import { isLiteral } from '../utils';
import { escapeText, escapeAttrValue } from './util';
function unreachable() {
    throw new Error('unreachable');
}
export default function build(ast) {
    if (!ast) {
        return '';
    }
    var output = [];
    switch (ast.type) {
        case 'Program':
            {
                var chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                var body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (ast.blockParams.length) {
                output.push(' ', 'as', ' ', '|' + ast.blockParams.join(' ') + '|');
            }
            if (voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            if (ast.value.type === 'TextNode') {
                if (ast.value.chars !== '') {
                    output.push(ast.name, '=');
                    output.push('"', escapeAttrValue(ast.value.chars), '"');
                } else {
                    output.push(ast.name);
                }
            } else {
                output.push(ast.name, '=');
                // ast.value is mustache or concat
                output.push(build(ast.value));
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(function (node) {
                if (node.type === 'TextNode') {
                    output.push(escapeAttrValue(node.chars));
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(escapeText(ast.chars));
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                var lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push('"' + ast.value + '"');
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(function (pair) {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(ast.key + '=' + build(ast.value));
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    var newArray = [];
    array.forEach(function (a) {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    var path = void 0;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if (isLiteral(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    var params = block.program.blockParams;
    if (params.length) {
        return ' as |' + params.join(' ') + '|';
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsQUFBTyxTQUFFLEFBQU8sQUFBRSxlQUFNLEFBQW9DLEFBQUM7QUFDN0QsQUFBTyxTQUFFLEFBQVMsQUFBRSxpQkFBTSxBQUFVLEFBQUM7QUFDckMsQUFBTyxTQUFFLEFBQVUsWUFBRSxBQUFlLEFBQUUsdUJBQU0sQUFBUSxBQUFDO0FBRXJELFNBQVMsQUFBVyxjQUNsQjtVQUFNLElBQUksQUFBSyxNQUFDLEFBQWEsQUFBQyxBQUFDLEFBQ2pDLEFBQUM7O0FBRUQsQUFBTSxBQUFDLEFBQU8sd0JBQVUsQUFBSyxNQUFDLEFBQWEsS0FDekM7UUFBSSxDQUFDLEFBQUcsS0FBRSxBQUNSO2VBQU8sQUFBRSxBQUFDLEFBQ1g7QUFDRDtRQUFNLEFBQU0sU0FBYSxBQUFFLEFBQUMsQUFFNUI7WUFBUSxBQUFHLElBQUMsQUFBSSxBQUFFLEFBQ2hCO2FBQUssQUFBUyxBQUNaO0FBQ0U7b0JBQU0sQUFBVSxhQUFHLEFBQUcsSUFBQyxBQUFTLEFBQUMsY0FBSSxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQUMsQUFBQyxBQUFDLEFBQ2pEO29CQUFJLEFBQVUsWUFBRSxBQUNkLEFBQVU7K0JBQUMsQUFBUyxBQUFDLGFBQUcsQUFBSSxBQUFDLEFBQzlCO0FBQ0Q7b0JBQU0sQUFBSSxPQUFHLEFBQVMsVUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQzFDLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQ25CO0FBQ0QsQUFBTTtBQUNSO2FBQUssQUFBYSxBQUNoQixBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFHLEtBQUUsQUFBRyxJQUFDLEFBQUcsQUFBQyxBQUFDLEFBQzFCO2dC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QUFBQyxBQUFDLEFBQ3BGLEFBQUM7O0FBRUQsU0FBUyxBQUFXLFlBQUMsQUFBdUIsT0FBRSxBQUFrQixXQUM5RDtXQUFPLEFBQU8sUUFBQyxBQUFLLEFBQUMsT0FBQyxBQUFJLEtBQUMsQUFBUyxhQUFJLEFBQUUsQUFBQyxBQUFDLEFBQzlDLEFBQUM7O0FBRUQsU0FBUyxBQUFXLFlBQUMsQUFBeUIsT0FDNUM7UUFBTSxBQUFNLFNBQUcsQUFBSyxNQUFDLEFBQU8sUUFBQyxBQUFXLEFBQUMsQUFDekM7UUFBSSxBQUFNLE9BQUMsQUFBTSxRQUFFLEFBQ2pCLEFBQU87eUJBQVEsQUFBTSxPQUFDLEFBQUksS0FBQyxBQUFHLEFBQUMsQUFBRyxBQUFDLEFBQ3BDO0FBRUQ7V0FBTyxBQUFJLEFBQUMsQUFDZCxBQUFDOztBQUVELFNBQVMsQUFBUyxVQUFDLEFBQXlCLE9BQzFDO1dBQU8sQ0FBQyxBQUFLLE9BQUUsQUFBVSxXQUFDLEFBQUssQUFBQyxRQUFFLEFBQVcsWUFBQyxBQUFLLEFBQUMsUUFBRSxBQUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDdkUsQUFBQzs7QUFFRCxTQUFTLEFBQVUsV0FBQyxBQUFVLE9BQzVCO1dBQU8sQ0FBQyxBQUFLLE9BQUUsQUFBSyxNQUFDLEFBQUssTUFBQyxBQUFJLEFBQUMsT0FBRSxBQUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDbkQsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0ICogYXMgSEJTIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IHZvaWRNYXAgfSBmcm9tICcuLi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzJztcbmltcG9ydCB7IGlzTGl0ZXJhbCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IGVzY2FwZVRleHQsIGVzY2FwZUF0dHJWYWx1ZSB9IGZyb20gJy4vdXRpbCc7XG5cbmZ1bmN0aW9uIHVucmVhY2hhYmxlKCk6IG5ldmVyIHtcbiAgdGhyb3cgbmV3IEVycm9yKCd1bnJlYWNoYWJsZScpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBidWlsZChhc3Q6IEhCUy5Ob2RlKTogc3RyaW5nIHtcbiAgaWYgKCFhc3QpIHtcbiAgICByZXR1cm4gJyc7XG4gIH1cbiAgY29uc3Qgb3V0cHV0OiBzdHJpbmdbXSA9IFtdO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdQcm9ncmFtJzpcbiAgICAgIHtcbiAgICAgICAgY29uc3QgY2hhaW5CbG9jayA9IGFzdFsnY2hhaW5lZCddICYmIGFzdC5ib2R5WzBdO1xuICAgICAgICBpZiAoY2hhaW5CbG9jaykge1xuICAgICAgICAgIGNoYWluQmxvY2tbJ2NoYWluZWQnXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYm9keSA9IGJ1aWxkRWFjaChhc3QuYm9keSkuam9pbignJyk7XG4gICAgICAgIG91dHB1dC5wdXNoKGJvZHkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2goJzwnLCBhc3QudGFnKTtcbiAgICAgIGlmIChhc3QuYXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmF0dHJpYnV0ZXMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBpZiAoYXN0Lm1vZGlmaWVycy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0Lm1vZGlmaWVycykuam9pbignICcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChhc3QuY29tbWVudHMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5jb21tZW50cykuam9pbignICcpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFzdC5ibG9ja1BhcmFtcy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCAnYXMnLCAnICcsIGB8JHthc3QuYmxvY2tQYXJhbXMuam9pbignICcpfXxgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHZvaWRNYXBbYXN0LnRhZ10pIHtcbiAgICAgICAgaWYgKGFzdC5zZWxmQ2xvc2luZykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKCcgLycpO1xuICAgICAgICB9XG5cbiAgICAgICAgb3V0cHV0LnB1c2goJz4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCc+Jyk7XG4gICAgICAgIG91dHB1dC5wdXNoLmFwcGx5KG91dHB1dCwgYnVpbGRFYWNoKGFzdC5jaGlsZHJlbikpO1xuICAgICAgICBvdXRwdXQucHVzaCgnPC8nLCBhc3QudGFnLCAnPicpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQXR0ck5vZGUnOlxuICAgICAgaWYgKGFzdC52YWx1ZS50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICAgIGlmIChhc3QudmFsdWUuY2hhcnMgIT09ICcnKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goYXN0Lm5hbWUsICc9Jyk7XG4gICAgICAgICAgb3V0cHV0LnB1c2goJ1wiJywgZXNjYXBlQXR0clZhbHVlKGFzdC52YWx1ZS5jaGFycyksICdcIicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGFzdC5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2goYXN0Lm5hbWUsICc9Jyk7XG4gICAgICAgIC8vIGFzdC52YWx1ZSBpcyBtdXN0YWNoZSBvciBjb25jYXRcbiAgICAgICAgb3V0cHV0LnB1c2goYnVpbGQoYXN0LnZhbHVlKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdDb25jYXRTdGF0ZW1lbnQnOlxuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgICBhc3QucGFydHMuZm9yRWFjaCgobm9kZTogSEJTLlRleHROb2RlIHwgSEJTLk11c3RhY2hlU3RhdGVtZW50KSA9PiB7XG4gICAgICAgIGlmIChub2RlLnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChlc2NhcGVBdHRyVmFsdWUobm9kZS5jaGFycykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGJ1aWxkKG5vZGUpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBvdXRwdXQucHVzaCgnXCInKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1RleHROb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKGVzY2FwZVRleHQoYXN0LmNoYXJzKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3snLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZUNvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7IS0tJywgYXN0LnZhbHVlLCAnLS19fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50TW9kaWZpZXJTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGF0aEV4cHJlc3Npb24nOlxuICAgICAgb3V0cHV0LnB1c2goYXN0Lm9yaWdpbmFsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgnKCcsIHBhdGhQYXJhbXMoYXN0KSwgJyknKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jvb2xlYW5MaXRlcmFsJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC52YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZScpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQmxvY2tTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAoYXN0WydjaGFpbmVkJ10pIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKFsne3tlbHNlICcsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10uam9pbignJykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxpbmVzLnB1c2gob3BlbkJsb2NrKGFzdCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QucHJvZ3JhbSkpO1xuXG4gICAgICAgIGlmIChhc3QuaW52ZXJzZSkge1xuICAgICAgICAgIGlmICghYXN0LmludmVyc2VbJ2NoYWluZWQnXSkge1xuICAgICAgICAgICAgbGluZXMucHVzaCgne3tlbHNlfX0nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QuaW52ZXJzZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFhc3RbJ2NoYWluZWQnXSkge1xuICAgICAgICAgIGxpbmVzLnB1c2goY2xvc2VCbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dC5wdXNoKGxpbmVzLmpvaW4oJycpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhcnRpYWxTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7PicsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJzwhLS0nLCBhc3QudmFsdWUsICctLT4nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnU3RyaW5nTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGBcIiR7YXN0LnZhbHVlfVwiYCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdW1iZXJMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goU3RyaW5nKGFzdC52YWx1ZSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnVW5kZWZpbmVkTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCd1bmRlZmluZWQnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ051bGxMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ251bGwnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0hhc2gnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChcbiAgICAgICAgICBhc3QucGFpcnNcbiAgICAgICAgICAgIC5tYXAocGFpciA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBidWlsZChwYWlyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuam9pbignICcpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoUGFpcic6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGAke2FzdC5rZXl9PSR7YnVpbGQoYXN0LnZhbHVlKX1gKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiBvdXRwdXQuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3QoYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IG5ld0FycmF5OiBhbnlbXSA9IFtdO1xuICBhcnJheS5mb3JFYWNoKGEgPT4ge1xuICAgIGlmICh0eXBlb2YgYSAhPT0gJ3VuZGVmaW5lZCcgJiYgYSAhPT0gbnVsbCAmJiBhICE9PSAnJykge1xuICAgICAgbmV3QXJyYXkucHVzaChhKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbmV3QXJyYXk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRWFjaChhc3RzOiBIQlMuTm9kZVtdKTogc3RyaW5nW10ge1xuICByZXR1cm4gYXN0cy5tYXAoYnVpbGQpO1xufVxuXG5mdW5jdGlvbiBwYXRoUGFyYW1zKGFzdDogSEJTLk5vZGUpOiBzdHJpbmcge1xuICBsZXQgcGF0aDogc3RyaW5nO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgY2FzZSAnU3ViRXhwcmVzc2lvbic6XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICBjYXNlICdCbG9ja1N0YXRlbWVudCc6XG4gICAgICBpZiAoaXNMaXRlcmFsKGFzdC5wYXRoKSkge1xuICAgICAgICByZXR1cm4gU3RyaW5nKGFzdC5wYXRoLnZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgcGF0aCA9IGJ1aWxkKGFzdC5wYXRoKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhcnRpYWxTdGF0ZW1lbnQnOlxuICAgICAgcGF0aCA9IGJ1aWxkKGFzdC5uYW1lKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdW5yZWFjaGFibGUoKTtcbiAgfVxuXG4gIHJldHVybiBjb21wYWN0Sm9pbihbcGF0aCwgYnVpbGRFYWNoKGFzdC5wYXJhbXMpLmpvaW4oJyAnKSwgYnVpbGQoYXN0Lmhhc2gpXSwgJyAnKTtcbn1cblxuZnVuY3Rpb24gY29tcGFjdEpvaW4oYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10sIGRlbGltaXRlcj86IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBjb21wYWN0KGFycmF5KS5qb2luKGRlbGltaXRlciB8fCAnJyk7XG59XG5cbmZ1bmN0aW9uIGJsb2NrUGFyYW1zKGJsb2NrOiBIQlMuQmxvY2tTdGF0ZW1lbnQpOiBPcHRpb248c3RyaW5nPiB7XG4gIGNvbnN0IHBhcmFtcyA9IGJsb2NrLnByb2dyYW0uYmxvY2tQYXJhbXM7XG4gIGlmIChwYXJhbXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGAgYXMgfCR7cGFyYW1zLmpvaW4oJyAnKX18YDtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBvcGVuQmxvY2soYmxvY2s6IEhCUy5CbG9ja1N0YXRlbWVudCk6IHN0cmluZyB7XG4gIHJldHVybiBbJ3t7IycsIHBhdGhQYXJhbXMoYmxvY2spLCBibG9ja1BhcmFtcyhibG9jayksICd9fSddLmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBjbG9zZUJsb2NrKGJsb2NrOiBhbnkpOiBzdHJpbmcge1xuICByZXR1cm4gWyd7ey8nLCBidWlsZChibG9jay5wYXRoKSwgJ319J10uam9pbignJyk7XG59XG4iXX0=