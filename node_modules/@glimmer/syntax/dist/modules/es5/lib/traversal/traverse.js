import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function getEnterFunction(handler) {
    return typeof handler === 'function' ? handler : handler.enter;
}
function getExitFunction(handler) {
    return typeof handler !== 'function' ? handler.exit : undefined;
}
function getKeyHandler(handler, key) {
    var keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    var keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        // widen specific key to all keys
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    var handler = visitor[nodeType];
    if (handler !== undefined) {
        // widen specific Node to all nodes
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, node) {
    var handler = getNodeHandler(visitor, node.type);
    var enter = void 0;
    var exit = void 0;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    var result = void 0;
    if (enter !== undefined) {
        result = enter(node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            visitArray(visitor, result);
            return result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        var keys = visitorKeys[node.type];
        for (var i = 0; i < keys.length; i++) {
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, node, keys[i]);
        }
        if (exit !== undefined) {
            result = exit(node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    var value = node[key];
    if (!value) {
        return;
    }
    var keyEnter = void 0;
    var keyExit = void 0;
    if (handler !== undefined) {
        var keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        var result = visitNode(visitor, value);
        if (result !== undefined) {
            assignKey(node, key, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (var i = 0; i < array.length; i++) {
        var result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(visitor, node);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUFNbEIsU0FBUyxBQUFnQixpQkFDdkIsQUFBaUMsU0FFakM7V0FBTyxPQUFPLEFBQU8sWUFBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sQUFBQyxBQUFDLFVBQUMsQUFBTyxRQUFDLEFBQUssQUFBQyxBQUNqRSxBQUFDOztBQUlELFNBQVMsQUFBZSxnQkFDdEIsQUFBaUMsU0FFakM7V0FBTyxPQUFPLEFBQU8sWUFBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sUUFBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQVMsQUFBQyxBQUNsRSxBQUFDOztBQUVELFNBQVMsQUFBYSxjQUFDLEFBQW9CLFNBQUUsQUFBYSxLQUN4RDtRQUFJLEFBQVUsYUFBRyxPQUFPLEFBQU8sWUFBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sUUFBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQVMsQUFBQyxBQUMxRTtRQUFJLEFBQVUsZUFBSyxBQUFTLFdBQUUsQUFBTyxBQUNyQztRQUFJLEFBQVUsYUFBRyxBQUFVLFdBQUMsQUFBRyxBQUFDLEFBQUMsQUFDakM7UUFBSSxBQUFVLGVBQUssQUFBUyxXQUFFLEFBQzVCLEFBQWlDO0FBQ2pDO2VBQU8sQUFBd0IsQUFBQyxBQUNqQztBQUNEO1dBQU8sQUFBVSxXQUFDLEFBQUcsQUFBQyxBQUN4QixBQUFDOztBQUVELFNBQVMsQUFBYyxlQUFDLEFBQW9CLFNBQUUsQUFBa0IsVUFDOUQ7UUFBSSxBQUFPLFVBQUcsQUFBTyxR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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdmlzaXRvcktleXMgZnJvbSAnLi4vdHlwZXMvdmlzaXRvci1rZXlzJztcbmltcG9ydCB7XG4gIGNhbm5vdFJlbW92ZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VOb2RlLFxuICBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQsXG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCB7IE5vZGUsIE5vZGVUeXBlLCBQYXJlbnROb2RlLCBDaGlsZEtleSB9IGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IE5vZGVWaXNpdG9yLCBOb2RlRnVuY3Rpb24sIE5vZGVIYW5kbGVyLCBLZXlGdW5jdGlvbiwgS2V5SGFuZGxlciB9IGZyb20gJy4uL3R5cGVzL3Zpc2l0b3InO1xuXG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uKGhhbmRsZXI6IEtleUhhbmRsZXIpOiBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcjogTm9kZUhhbmRsZXIpOiBOb2RlRnVuY3Rpb24gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uKFxuICBoYW5kbGVyOiBOb2RlSGFuZGxlciB8IEtleUhhbmRsZXJcbik6IE5vZGVGdW5jdGlvbiB8IEtleUZ1bmN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgcmV0dXJuIHR5cGVvZiBoYW5kbGVyID09PSAnZnVuY3Rpb24nID8gaGFuZGxlciA6IGhhbmRsZXIuZW50ZXI7XG59XG5cbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbihoYW5kbGVyOiBLZXlIYW5kbGVyKTogS2V5RnVuY3Rpb24gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb24oaGFuZGxlcjogTm9kZUhhbmRsZXIpOiBOb2RlRnVuY3Rpb24gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb24oXG4gIGhhbmRsZXI6IE5vZGVIYW5kbGVyIHwgS2V5SGFuZGxlclxuKTogTm9kZUZ1bmN0aW9uIHwgS2V5RnVuY3Rpb24gfCB1bmRlZmluZWQge1xuICByZXR1cm4gdHlwZW9mIGhhbmRsZXIgIT09ICdmdW5jdGlvbicgPyBoYW5kbGVyLmV4aXQgOiB1bmRlZmluZWQ7XG59XG5cbmZ1bmN0aW9uIGdldEtleUhhbmRsZXIoaGFuZGxlcjogTm9kZUhhbmRsZXIsIGtleTogQ2hpbGRLZXkpOiBLZXlIYW5kbGVyIHwgdW5kZWZpbmVkIHtcbiAgbGV0IGtleVZpc2l0b3IgPSB0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJyA/IGhhbmRsZXIua2V5cyA6IHVuZGVmaW5lZDtcbiAgaWYgKGtleVZpc2l0b3IgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuICBsZXQga2V5SGFuZGxlciA9IGtleVZpc2l0b3Jba2V5XTtcbiAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIC8vIHdpZGVuIHNwZWNpZmljIGtleSB0byBhbGwga2V5c1xuICAgIHJldHVybiBrZXlIYW5kbGVyIGFzIEtleUhhbmRsZXI7XG4gIH1cbiAgcmV0dXJuIGtleVZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcih2aXNpdG9yOiBOb2RlVmlzaXRvciwgbm9kZVR5cGU6IE5vZGVUeXBlKTogTm9kZUhhbmRsZXIgfCB1bmRlZmluZWQge1xuICBsZXQgaGFuZGxlciA9IHZpc2l0b3Jbbm9kZVR5cGVdO1xuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgLy8gd2lkZW4gc3BlY2lmaWMgTm9kZSB0byBhbGwgbm9kZXNcbiAgICByZXR1cm4gaGFuZGxlciBhcyBOb2RlSGFuZGxlcjtcbiAgfVxuICByZXR1cm4gdmlzaXRvci5BbGw7XG59XG5cbmZ1bmN0aW9uIHZpc2l0Tm9kZSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgbm9kZTogTm9kZSk6IE5vZGUgfCBOb2RlW10gfCB1bmRlZmluZWQgfCBudWxsIHwgdm9pZCB7XG4gIGxldCBoYW5kbGVyID0gZ2V0Tm9kZUhhbmRsZXIodmlzaXRvciwgbm9kZS50eXBlKTtcbiAgbGV0IGVudGVyOiBOb2RlRnVuY3Rpb24gfCB1bmRlZmluZWQ7XG4gIGxldCBleGl0OiBOb2RlRnVuY3Rpb24gfCB1bmRlZmluZWQ7XG5cbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGVudGVyID0gZ2V0RW50ZXJGdW5jdGlvbihoYW5kbGVyKTtcbiAgICBleGl0ID0gZ2V0RXhpdEZ1bmN0aW9uKGhhbmRsZXIpO1xuICB9XG5cbiAgbGV0IHJlc3VsdDogTm9kZSB8IE5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkO1xuICBpZiAoZW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlc3VsdCA9IGVudGVyKG5vZGUpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdmlzaXROb2RlKHZpc2l0b3IsIHJlc3VsdCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgLy8gd2Uga25vdyBpZiBpdCBoYXMgY2hpbGQga2V5cyB3ZSBjYW4gd2lkZW4gdG8gYSBQYXJlbnROb2RlXG4gICAgICB2aXNpdEtleSh2aXNpdG9yLCBoYW5kbGVyLCBub2RlIGFzIFBhcmVudE5vZGUsIGtleXNbaV0pO1xuICAgIH1cblxuICAgIGlmIChleGl0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJlc3VsdCA9IGV4aXQobm9kZSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXkoXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBoYW5kbGVyOiBOb2RlSGFuZGxlciB8IHVuZGVmaW5lZCxcbiAgbm9kZTogUGFyZW50Tm9kZSxcbiAga2V5OiBDaGlsZEtleVxuKSB7XG4gIGxldCB2YWx1ZSA9IG5vZGVba2V5XSBhcyBOb2RlIHwgTm9kZVtdIHwgbnVsbCB8IHVuZGVmaW5lZDtcbiAgaWYgKCF2YWx1ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBrZXlFbnRlcjogS2V5RnVuY3Rpb24gfCB1bmRlZmluZWQ7XG4gIGxldCBrZXlFeGl0OiBLZXlGdW5jdGlvbiB8IHVuZGVmaW5lZDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleUhhbmRsZXIgPSBnZXRLZXlIYW5kbGVyKGhhbmRsZXIsIGtleSk7XG4gICAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAga2V5RW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgICAga2V5RXhpdCA9IGdldEV4aXRGdW5jdGlvbihrZXlIYW5kbGVyKTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChrZXlFbnRlcihub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgYXNzaWduS2V5KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUV4aXQobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgYXJyYXk6IE5vZGVbXSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCBhcnJheVtpXSk7XG4gICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpICs9IHNwbGljZUFycmF5KGFycmF5LCBpLCByZXN1bHQpIC0gMTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzaWduS2V5KG5vZGU6IE5vZGUsIGtleTogQ2hpbGRLZXksIHJlc3VsdDogTm9kZSB8IE5vZGVbXSB8IG51bGwpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAxKSB7XG4gICAgICBub2RlW2tleV0gPSByZXN1bHRbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU5vZGUobm9kZVtrZXldLCBub2RlLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBub2RlW2tleV0gPSByZXN1bHQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gc3BsaWNlQXJyYXkoYXJyYXk6IE5vZGVbXSwgaW5kZXg6IG51bWJlciwgcmVzdWx0OiBOb2RlIHwgTm9kZVtdIHwgbnVsbCkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIC4uLnJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGg7XG4gIH0gZWxzZSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCByZXN1bHQpO1xuICAgIHJldHVybiAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGU6IE5vZGUsIHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIHZpc2l0Tm9kZSh2aXNpdG9yLCBub2RlKTtcbn1cbiJdfQ==