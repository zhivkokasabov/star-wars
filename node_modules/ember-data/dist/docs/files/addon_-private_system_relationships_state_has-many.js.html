<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/-private/system/relationships/state/has-many.js - The ember-data API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="The ember-data API" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: v3.7.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/DS.html">DS</a></li>
                                <li><a href="../classes/DS.AbortError.html">DS.AbortError</a></li>
                                <li><a href="../classes/DS.Adapter.html">DS.Adapter</a></li>
                                <li><a href="../classes/DS.AdapterError.html">DS.AdapterError</a></li>
                                <li><a href="../classes/DS.AdapterPopulatedRecordArray.html">DS.AdapterPopulatedRecordArray</a></li>
                                <li><a href="../classes/DS.BelongsToReference.html">DS.BelongsToReference</a></li>
                                <li><a href="../classes/DS.BooleanTransform.html">DS.BooleanTransform</a></li>
                                <li><a href="../classes/DS.BuildURLMixin.html">DS.BuildURLMixin</a></li>
                                <li><a href="../classes/DS.ConflictError.html">DS.ConflictError</a></li>
                                <li><a href="../classes/DS.DateTransform.html">DS.DateTransform</a></li>
                                <li><a href="../classes/DS.EmbeddedRecordsMixin.html">DS.EmbeddedRecordsMixin</a></li>
                                <li><a href="../classes/DS.Ember.HTMLBars.helpers.html">DS.Ember.HTMLBars.helpers</a></li>
                                <li><a href="../classes/DS.Errors.html">DS.Errors</a></li>
                                <li><a href="../classes/DS.ForbiddenError.html">DS.ForbiddenError</a></li>
                                <li><a href="../classes/DS.HasManyReference.html">DS.HasManyReference</a></li>
                                <li><a href="../classes/DS.InvalidError.html">DS.InvalidError</a></li>
                                <li><a href="../classes/DS.JSONAPIAdapter.html">DS.JSONAPIAdapter</a></li>
                                <li><a href="../classes/DS.JSONAPISerializer.html">DS.JSONAPISerializer</a></li>
                                <li><a href="../classes/DS.JSONSerializer.html">DS.JSONSerializer</a></li>
                                <li><a href="../classes/DS.ManyArray.html">DS.ManyArray</a></li>
                                <li><a href="../classes/DS.Model.html">DS.Model</a></li>
                                <li><a href="../classes/DS.NotFoundError.html">DS.NotFoundError</a></li>
                                <li><a href="../classes/DS.NumberTransform.html">DS.NumberTransform</a></li>
                                <li><a href="../classes/DS.PromiseArray.html">DS.PromiseArray</a></li>
                                <li><a href="../classes/DS.PromiseManyArray.html">DS.PromiseManyArray</a></li>
                                <li><a href="../classes/DS.PromiseObject.html">DS.PromiseObject</a></li>
                                <li><a href="../classes/DS.RecordArray.html">DS.RecordArray</a></li>
                                <li><a href="../classes/DS.RecordArrayManager.html">DS.RecordArrayManager</a></li>
                                <li><a href="../classes/DS.RecordReference.html">DS.RecordReference</a></li>
                                <li><a href="../classes/DS.RESTAdapter.html">DS.RESTAdapter</a></li>
                                <li><a href="../classes/DS.RESTSerializer.html">DS.RESTSerializer</a></li>
                                <li><a href="../classes/DS.RootState.html">DS.RootState</a></li>
                                <li><a href="../classes/DS.Serializer.html">DS.Serializer</a></li>
                                <li><a href="../classes/DS.ServerError.html">DS.ServerError</a></li>
                                <li><a href="../classes/DS.Snapshot.html">DS.Snapshot</a></li>
                                <li><a href="../classes/DS.SnapshotRecordArray.html">DS.SnapshotRecordArray</a></li>
                                <li><a href="../classes/DS.Store.html">DS.Store</a></li>
                                <li><a href="../classes/DS.String.html">DS.String</a></li>
                                <li><a href="../classes/DS.StringTransform.html">DS.StringTransform</a></li>
                                <li><a href="../classes/DS.TimeoutError.html">DS.TimeoutError</a></li>
                                <li><a href="../classes/DS.Transform.html">DS.Transform</a></li>
                                <li><a href="../classes/DS.UnauthorizedError.html">DS.UnauthorizedError</a></li>
                                <li><a href="../classes/Ember.HTMLBars.helpers.html">Ember.HTMLBars.helpers</a></li>
                                <li><a href="../classes/Ember.Inflector.html">Ember.Inflector</a></li>
                                <li><a href="../classes/IdentityMap.html">IdentityMap</a></li>
                                <li><a href="../classes/InternalModelMap.html">InternalModelMap</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ember-data.html">ember-data</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: addon/-private/system/relationships/state/has-many.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import { assertPolymorphicType } from &#x27;ember-data/-debug&#x27;;
import Relationship from &#x27;./relationship&#x27;;
import OrderedSet from &#x27;../../ordered-set&#x27;;
import { isNone } from &#x27;@ember/utils&#x27;;

export default class ManyRelationship extends Relationship {
  constructor(store, inverseKey, relationshipMeta, recordData, inverseIsAsync) {
    super(store, inverseKey, relationshipMeta, recordData, inverseIsAsync);
    this.canonicalState = [];
    this.currentState = [];
    this._willUpdateManyArray = false;
    this._pendingManyArrayUpdates = null;
  }

  removeInverseRelationships() {
    super.removeInverseRelationships();

    /* TODO Igor make sure this is still working
    if (this._promiseProxy) {
      this._promiseProxy.destroy();
    }
    */
  }

  addCanonicalRecordData(recordData, idx) {
    if (this.canonicalMembers.has(recordData)) {
      return;
    }
    if (idx !== undefined) {
      this.canonicalState.splice(idx, 0, recordData);
    } else {
      this.canonicalState.push(recordData);
    }
    super.addCanonicalRecordData(recordData, idx);
  }

  inverseDidDematerialize(inverseRecordData) {
    super.inverseDidDematerialize(inverseRecordData);
    if (this.isAsync) {
      this.notifyManyArrayIsStale();
    }
  }

  addRecordData(recordData, idx) {
    if (this.members.has(recordData)) {
      return;
    }

    assertPolymorphicType(this.recordData, this.relationshipMeta, recordData, this.store);
    super.addRecordData(recordData, idx);
    // make lazy later
    if (idx === undefined) {
      idx = this.currentState.length;
    }
    this.currentState.splice(idx, 0, recordData);
    // TODO Igor consider making direct to remove the indirection
    // We are not lazily accessing the manyArray here because the change is coming from app side
    // this.manyArray.flushCanonical(this.currentState);
    this.notifyHasManyChange();
  }

  removeCanonicalRecordDataFromOwn(recordData, idx) {
    let i = idx;
    if (!this.canonicalMembers.has(recordData)) {
      return;
    }
    if (i === undefined) {
      i = this.canonicalState.indexOf(recordData);
    }
    if (i &gt; -1) {
      this.canonicalState.splice(i, 1);
    }
    super.removeCanonicalRecordDataFromOwn(recordData, idx);
    //TODO(Igor) Figure out what to do here
  }

  removeAllCanonicalRecordDatasFromOwn() {
    super.removeAllCanonicalRecordDatasFromOwn();
    this.canonicalMembers.clear();
    this.canonicalState.splice(0, this.canonicalState.length);
    super.removeAllCanonicalRecordDatasFromOwn();
  }

  //TODO(Igor) DO WE NEED THIS?
  removeCompletelyFromOwn(recordData) {
    super.removeCompletelyFromOwn(recordData);

    // TODO SkEPTICAL
    const canonicalIndex = this.canonicalState.indexOf(recordData);

    if (canonicalIndex !== -1) {
      this.canonicalState.splice(canonicalIndex, 1);
    }

    this.removeRecordDataFromOwn(recordData);
  }

  flushCanonical() {
    let toSet = this.canonicalState;

    //a hack for not removing new records
    //TODO remove once we have proper diffing
    let newRecordDatas = this.currentState.filter(
      // only add new internalModels which are not yet in the canonical state of this
      // relationship (a new internalModel can be in the canonical state if it has
      // been &#x27;acknowleged&#x27; to be in the relationship via a store.push)

      //TODO Igor deal with this
      recordData =&gt; recordData.isNew() &amp;&amp; toSet.indexOf(recordData) === -1
    );
    toSet = toSet.concat(newRecordDatas);

    /*
    if (this._manyArray) {
      this._manyArray.flushCanonical(toSet);
    }
    */
    this.currentState = toSet;
    super.flushCanonical();
    // Once we clean up all the flushing, we will be left with at least the notifying part
    this.notifyHasManyChange();
  }

  //TODO(Igor) idx not used currently, fix
  removeRecordDataFromOwn(recordData, idx) {
    super.removeRecordDataFromOwn(recordData, idx);
    let index = idx || this.currentState.indexOf(recordData);

    //TODO IGOR DAVID INVESTIGATE
    if (index === -1) {
      return;
    }
    this.currentState.splice(index, 1);
    // TODO Igor consider making direct to remove the indirection
    // We are not lazily accessing the manyArray here because the change is coming from app side
    this.notifyHasManyChange();
    // this.manyArray.flushCanonical(this.currentState);
  }

  notifyRecordRelationshipAdded() {
    this.notifyHasManyChange();
  }

  computeChanges(recordDatas = []) {
    let members = this.canonicalMembers;
    let recordDatasToRemove = [];
    let recordDatasSet = setForArray(recordDatas);

    members.forEach(member =&gt; {
      if (recordDatasSet.has(member)) {
        return;
      }

      recordDatasToRemove.push(member);
    });

    this.removeCanonicalRecordDatas(recordDatasToRemove);

    for (let i = 0, l = recordDatas.length; i &lt; l; i++) {
      let recordData = recordDatas[i];
      this.removeCanonicalRecordData(recordData);
      this.addCanonicalRecordData(recordData, i);
    }
  }

  setInitialRecordDatas(recordDatas) {
    if (Array.isArray(recordDatas) === false || recordDatas.length === 0) {
      return;
    }

    for (let i = 0; i &lt; recordDatas.length; i++) {
      let recordData = recordDatas[i];
      if (this.canonicalMembers.has(recordData)) {
        continue;
      }

      this.canonicalMembers.add(recordData);
      this.members.add(recordData);
      this.setupInverseRelationship(recordData);
    }

    this.canonicalState = this.canonicalMembers.toArray();
  }

  /*
    This is essentially a &quot;sync&quot; version of
      notifyHasManyChange. We should work to unify
      these worlds

      - @runspired
  */
  notifyManyArrayIsStale() {
    let recordData = this.recordData;
    let storeWrapper = recordData.storeWrapper;
    storeWrapper.notifyPropertyChange(
      recordData.modelName,
      recordData.id,
      recordData.clientId,
      this.key
    );
  }

  notifyHasManyChange() {
    let recordData = this.recordData;
    let storeWrapper = recordData.storeWrapper;
    storeWrapper.notifyHasManyChange(
      recordData.modelName,
      recordData.id,
      recordData.clientId,
      this.key
    );
  }

  getData() {
    let payload = {};
    if (this.hasAnyRelationshipData) {
      payload.data = this.currentState.map(recordData =&gt; recordData.getResourceIdentifier());
    }
    if (this.link) {
      payload.links = {
        related: this.link,
      };
    }
    if (this.meta) {
      payload.meta = this.meta;
    }

    // TODO @runspired: the @igor refactor is too limiting for relationship state
    //   we should reconsider where we fetch from.
    payload._relationship = this;

    return payload;
  }

  updateData(data, initial) {
    let recordDatas;
    if (isNone(data)) {
      recordDatas = undefined;
    } else {
      recordDatas = new Array(data.length);
      for (let i = 0; i &lt; data.length; i++) {
        recordDatas[i] = this.recordData.storeWrapper.recordDataFor(data[i].type, data[i].id);
      }
    }
    if (initial) {
      this.setInitialRecordDatas(recordDatas);
    } else {
      this.updateRecordDatasFromAdapter(recordDatas);
    }
  }

  /**
   * Flag indicating whether all inverse records are available
   *
   * true if inverse records exist and are all loaded (all not empty)
   * true if there are no inverse records
   * false if the inverse records exist and any are not loaded (any empty)
   *
   * @return {boolean}
   */
  get allInverseRecordsAreLoaded() {
    // check currentState for unloaded records
    let hasEmptyRecords = this.currentState.reduce((hasEmptyModel, i) =&gt; {
      return hasEmptyModel || i.isEmpty();
    }, false);
    // check un-synced state for unloaded records
    if (!hasEmptyRecords &amp;&amp; this.willSync) {
      hasEmptyRecords = this.canonicalState.reduce((hasEmptyModel, i) =&gt; {
        return hasEmptyModel || !i.isEmpty();
      }, false);
    }

    return !hasEmptyRecords;
  }
}

function setForArray(array) {
  var set = new OrderedSet();

  if (array) {
    for (var i = 0, l = array.length; i &lt; l; i++) {
      set.add(array[i]);
    }
  }

  return set;
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
